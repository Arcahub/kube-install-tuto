<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating our first deployment (advanced) - How to deploy a Kubernetes cluster</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A guide to deploy a Kubernetes cluster for a course at Ynov School">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="k8s-components.html"><strong aria-hidden="true">2.</strong> Understanding Kubernetes Components</a></li><li class="chapter-item expanded "><a href="infrastructure.html"><strong aria-hidden="true">3.</strong> Infrastructure Provisioning</a></li><li class="chapter-item expanded "><a href="installation/installation.html"><strong aria-hidden="true">4.</strong> Kubernetes installation with kubeadm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="installation/controlplane-node.html"><strong aria-hidden="true">4.1.</strong> Setting up control plane node</a></li><li class="chapter-item expanded "><a href="installation/worker-node.html"><strong aria-hidden="true">4.2.</strong> Setting up worker node</a></li><li class="chapter-item expanded "><a href="installation/conclusion.html"><strong aria-hidden="true">4.3.</strong> Installation conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="understanding.html"><strong aria-hidden="true">5.</strong> Understanding what we have done</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="understanding/static-pods.html"><strong aria-hidden="true">5.1.</strong> Static pods</a></li><li class="chapter-item expanded "><a href="understanding/certificates.html"><strong aria-hidden="true">5.2.</strong> Certificates</a></li></ol></li><li class="chapter-item expanded "><a href="first-deployment.html" class="active"><strong aria-hidden="true">6.</strong> Creating our first deployment (advanced)</a></li><li class="chapter-item expanded "><a href="scheduler.html"><strong aria-hidden="true">7.</strong> Playing with the scheduler</a></li><li class="chapter-item expanded "><a href="version-upgrade.html"><strong aria-hidden="true">8.</strong> Upgrading cluster version</a></li><li class="chapter-item expanded "><a href="create-config.html"><strong aria-hidden="true">9.</strong> Create a config for a developer (advanced)</a></li><li class="chapter-item expanded "><a href="bonus.html"><strong aria-hidden="true">10.</strong> Bonus</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">How to deploy a Kubernetes cluster</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="creating-our-first-deployment"><a class="header" href="#creating-our-first-deployment">Creating our first deployment</a></h1>
<p>Now that we have a working cluster, we can deploy our first application. But you should already have deployed something on Kubernetes, right? So to make it more interesting, I will explain you what happens behind the scenes when you run <code>kubectl create deployment nginx --image=nginx --replicas=3</code>.</p>
<p><a href="https://github.com/jamiehannaford/what-happens-when-k8s">source</a></p>
<h2 id="client-side"><a class="header" href="#client-side">Client side</a></h2>
<p>So let's get started. The firt things happening when you run <code>kubectl create deployment nginx --image=nginx --replicas=3</code> is that the client will read the file and perform client side validation. It will check if the file is a valid YAML file and if it contains the required fields. If it doesn't, it will return an error.</p>
<p>Then the client will create an HTTP request for the API server that will contains the YAML object. To do so, it will read the kubeconfig file to get the API server URL and the certificate to authenticate to the API server.</p>
<p>Finally, the client will send the request to the API server.</p>
<h2 id="api-server"><a class="header" href="#api-server">API server</a></h2>
<p>When the API server receive the request, it will first authenticate the client using the certificate. Then it will check if the request is authorized by checking the RBAC rules linked to the user. If the request is authorized, it will check if the object is valid. It will check if the object is a valid Kubernetes object and if it contains the required fields. If it doesn't, it will return an error.</p>
<p>As the last defense, the API server will check if the object is valid against the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-are-they">admission controllers</a>. We won't go into details about the admission controllers but they are a set of plugins that can modify or reject objects. For example, the <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">PodSecurityPolicy</a> admission controller will check if the Pod is compliant with the PodSecurityPolicy.</p>
<p>At this point the request has been fully verified and the API server will store the object in the etcd database.</p>
<h2 id="controller-manager"><a class="header" href="#controller-manager">Controller manager</a></h2>
<p>Now that the object is stored in the etcd database, the next step is to create the corresponding Kubernetes object. A Deployment is a collection of ReplicaSets and a ReplicaSet is a collection of Pods. So the controller manager will create the ReplicaSet and the Pods and to do so, it will use Kubernetes' built-in controllers.</p>
<p>A controller is a loop that will check if the desired state stored in <code>etcd</code> is the same as the current state of the cluster. If it's not, it will try to reconcile the two states. For example, if you have a Deployment with 3 replicas and you delete one of the Pods, the controller will notice that the desired state is 3 Pods and the current state is 2 Pods and it will create a new Pod to reach the desired state.</p>
<p>So after a Deployment is stored in <code>etcd</code>, it is detected by the Deployment controller that will detect the <code>create</code> event on the Deployment. It will then that there are no ReplicaSets associated with the Deployment and it will create one. It will work similarly for the ReplicaSet and the Pods. If you want to know more about the controllers, you can read the <a href="https://kubernetes.io/docs/concepts/architecture/controller/">official documentation</a> and this article about <a href="http://borismattijssen.github.io/articles/kubernetes-informers-controllers-reflectors-stores">Kubernetes controllers</a>.</p>
<h2 id="scheduler"><a class="header" href="#scheduler">Scheduler</a></h2>
<p>After all the controllers have done their job, we have a Deployment, a ReplicaSet and a set of Pods stored in <code>etcd</code> but nothing is running on the nodes. To be more precise, the Pods are in the <code>Pending</code> state. The reason is that the Pods are not scheduled on any node.</p>
<p>The scheduler is responsible for scheduling the Pods on the nodes. It will check the Pod's requirements and try to find a node that can run the Pod. If it finds a node, it will update the Pod's <code>spec.nodeName</code> field and the Pod will be scheduled on the node.</p>
<p>For example, if you have a Pod that requires 1 CPU and 1GB of RAM, the scheduler will first filter the nodes with a series of predicates to assure they match the requirements of the Pod. Then it will rank the nodes with a series of priorities to find the best node. For example, it will try to find a node with the lowest number of Pods to reduce the risk of resource contention.</p>
<p>Again, if you want to know more about the scheduler, you can read the <a href="https://kubernetes.io/docs/concepts/scheduling/kube-scheduler/">official documentation</a>.</p>
<h2 id="kubelet"><a class="header" href="#kubelet">Kubelet</a></h2>
<p>At this point, the Pods are scheduled on nodes with the <code>spec.nodeName</code> field set but they are still not running. And that's the job of <code>kubelet</code>.</p>
<p>As you know <code>kubelet</code> is the agent that runs on each node. It is responsible for translating the abstract Pod definition into a running container. To achieve that, it will query the API server to get the list of Pods by filtering on Pods that have the <code>spec.nodeName</code> field that correspond to the name of the node where the <code>kubelet</code> querying is running. Then it will detect change by comparing with its local cache. If there is a change, it will try to reconcile the two states.</p>
<p>For our example, the <code>kubelet</code> will see that the Pod is scheduled on the node and it will try to run it. To do so, it will use the container runtime to run the container. If the container is running, the Pod will be in the <code>Running</code> state.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Well, that's it. This is the whole process that happens when you run <code>kubectl create deployment nginx --image=nginx --replicas=3</code>. Of course we can always go deeper and explain what happens in each step but if you have understood this article, you should have a good understanding of how Kubernetes works.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="understanding/certificates.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="scheduler.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="understanding/certificates.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="scheduler.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
