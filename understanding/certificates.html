<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Certificates - How to deploy a Kubernetes cluster</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A guide to deploy a Kubernetes cluster for a course at Ynov School">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../k8s-components.html"><strong aria-hidden="true">2.</strong> Understanding Kubernetes Components</a></li><li class="chapter-item expanded "><a href="../infrastructure.html"><strong aria-hidden="true">3.</strong> Infrastructure Provisioning</a></li><li class="chapter-item expanded "><a href="../installation/installation.html"><strong aria-hidden="true">4.</strong> Kubernetes installation with kubeadm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/controlplane-node.html"><strong aria-hidden="true">4.1.</strong> Setting up control plane node</a></li><li class="chapter-item expanded "><a href="../installation/worker-node.html"><strong aria-hidden="true">4.2.</strong> Setting up worker node</a></li><li class="chapter-item expanded "><a href="../installation/conclusion.html"><strong aria-hidden="true">4.3.</strong> Installation conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="../understanding.html"><strong aria-hidden="true">5.</strong> Understanding what we have done</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../understanding/static-pods.html"><strong aria-hidden="true">5.1.</strong> Static pods</a></li><li class="chapter-item expanded "><a href="../understanding/certificates.html" class="active"><strong aria-hidden="true">5.2.</strong> Certificates</a></li></ol></li><li class="chapter-item expanded "><a href="../first-deployment.html"><strong aria-hidden="true">6.</strong> Creating our first deployment (advanced)</a></li><li class="chapter-item expanded "><a href="../scheduler.html"><strong aria-hidden="true">7.</strong> Playing with the scheduler</a></li><li class="chapter-item expanded "><a href="../version-upgrade.html"><strong aria-hidden="true">8.</strong> Upgrading cluster version</a></li><li class="chapter-item expanded "><a href="../create-config.html"><strong aria-hidden="true">9.</strong> Create a config for a developer (advanced)</a></li><li class="chapter-item expanded "><a href="../bonus.html"><strong aria-hidden="true">10.</strong> Bonus</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">How to deploy a Kubernetes cluster</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="certificates"><a class="header" href="#certificates">Certificates</a></h1>
<p>As we said previously <code>kubeadm init</code> generates a set of certificates. All these certificates are stored in <code>/etc/kubernetes/pki</code>. This directory is used by Kubernetes to store certificates and keys. But what are these certificates for ?</p>
<h2 id="pki-public-key-infrastructure"><a class="header" href="#pki-public-key-infrastructure">PKI (Public Key Infrastructure)</a></h2>
<p>Kubernetes uses a PKI to secure the communication between components. PKI is a set of cryptographic tools that are used to generate, store and distribute certificates. The PKI used by Kubernetes is based on the PKI used by <code>etcd</code>. The PKI is composed of 3 main elements:</p>
<ul>
<li>Certificate Authority(CA) certificates</li>
<li>Components certificates</li>
<li>Users certificates</li>
</ul>
<h2 id="certificate-authorityca-certificates"><a class="header" href="#certificate-authorityca-certificates">Certificate Authority(CA) certificates</a></h2>
<p>The first certificate generated is the CA certificate. CA mean Certificate Authority. It is the root certificate that is used to sign all the other certificates. That means that we can validate a certificate by checking if it has been signed by the CA certificate.</p>
<p>This certificate is stored in <code>/etc/kubernetes/pki/ca.crt</code> and the private key in <code>/etc/kubernetes/pki/ca.key</code>. The private key is used to sign the other certificates.</p>
<h2 id="components-certificates"><a class="header" href="#components-certificates">Components certificates</a></h2>
<p>There is a pair of certificate and private key for each component of Kubernetes. The list of components is:</p>
<ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>kube-proxy</li>
<li>kubelet</li>
</ul>
<h2 id="etcd-certificates"><a class="header" href="#etcd-certificates">Etcd certificates</a></h2>
<p>Etcd has its own PKI. The list of certificates is:</p>
<ul>
<li>etcd-ca</li>
<li>etcd-server</li>
<li>etcd-peer</li>
<li>etcd-healthcheck-client</li>
</ul>
<h2 id="enable-authentication-for-kubelet-advanced"><a class="header" href="#enable-authentication-for-kubelet-advanced">Enable authentication for kubelet (advanced)</a></h2>
<p>The <code>kubelet</code> is the agent that runs on each node. It is responsible for starting and stopping containers. It also exposes an API but by default it is not secured. This means that anyone can access the API. Your task is to secure <code>kubelet</code> by enabling certificate authentication.</p>
<h2 id="certificate-management-with-kubeadm"><a class="header" href="#certificate-management-with-kubeadm">Certificate management with kubeadm</a></h2>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">source</a></p>
<p>Certificates expire after a given time. This time is called the certificate lifetime. The default lifetime for the component's certificates is 1 year and for the CA certificate is 10 years. The rotation of the certificates is done using <code>kubeadm</code>.</p>
<p>You can check the expiration date of the certificates using the following command:</p>
<pre><code class="language-bash">kubeadm certs check-expiration
</code></pre>
<p>You can renew all the certificates using the following command:</p>
<pre><code class="language-bash">kubeadm certs renew all
</code></pre>
<p>You can renew a specific certificate using the following command:</p>
<pre><code class="language-bash">kubeadm certs renew &lt;certificate-name&gt;
</code></pre>
<p>Example for the <code>kube-apiserver</code> certificate:</p>
<pre><code class="language-bash">kubeadm certs renew kube-apiserver
</code></pre>
<p>After renewing the certificates you need to restart the components that use them. To do so you can move the manifests of the static pods like we saw in the previous chapter.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Certificates are an important part of Kubernetes since they are the reasons we are able to have node to node communications over public networks. In the next chapter we will see in details what happens when we create a deployment.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../understanding/static-pods.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../first-deployment.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../understanding/static-pods.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../first-deployment.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
